#! /usr/bin/env bash

_domchk(){
D="$(pwd | cut -d/ -f4)"
V="$(ls /etc/httpd/conf.d/ \
| grep "vhost_"$D".conf")"

  if [[ -n "$V" ]]; then
    DOM="$D"
else
    echo "What is the Master Domain?: "
    read DOM
    _vhostchk
  fi
}

_vhostchk(){
V="$(ls /etc/httpd/conf.d/ \
| grep "vhost_"$DOM".conf")"

  if [[ -z "$V" ]]; then
     echo "No Domain Found"
     _domchk
  fi
}
_userinfo(){
R="$(siteworx -u --login_domain="$DOM" -n \
-c overview -a listAccountDetails \
| head -n1 | awk '{print $2}')"
   echo -n "User: "
   read U
J="$(echo "$U" | grep "$R")"
if [[ -n "$U" ]]; then
U="$(echo "$U" | cut -d_ -f2)"
else
U="$(echo "$U")"
fi
}

_userchk(){
C="$(sudo siteworx -u --login_domain="$DOM" \
-c MysqlUser -n -a listMysqlUsers | awk '{print $2}'| grep "$R_$U$")"

if [[ -z "$C" ]]; then
_passinfo
else
echo "User exists!"
_userinfo
 fi
}

_pwg(){
if [[ -e /usr/local/interworx/lib/dict/words ]]; then

    D='/usr/local/interworx/lib/dict/words';
    _getpass
else
   D='/usr/share/dict/words'
   _getpass
fi
}

_getpass(){
W1="$(shuf -n1000 "$D" | head -n1 | sed -e 's|["'\'']||g')"
W2="$(shuf -n1000 "$D" | tail -n1 | sed -e 's|["'\'']||g')"
W3="$(shuf -n1000 "$D" | head -n1 | sed -e 's|["'\'']||g')"
W4="$(shuf -n1000 "$D" | tail -n1 | sed -e 's|["'\'']||g')"
W5="$(shuf -n1000 "$D" | tail -n1 | sed -e 's|["'\'']||g')"
N="$(seq 99 | sort -R | tail -n1)"
 echo ""$W1""$W2""$W3""$W""$W5""$N""
}
_passinfo(){
   echo -n "New password (defualt random): "
   read PW
 if [ -z "$PW" ]; then
   PW="$(_pwg)"
else
   PW="$PW"
 fi
}

_adduser1(){
echo -n "DB: "
  read DB1
J="$(echo "$DB1" | grep "$R")"
if [[ -n "$J" ]]; then
DB="$(echo "$DB1" | cut -d_ -f2)"
else
DB="$(echo "$DB1")"
fi

echo "adding user..."
sudo siteworx -u --login_domain="$DOM" \
-c MysqlUser -n -a add --name "$U" \
--password "$PW" --confirm_password "$PW"
siteworx -u --login_domain="$DOM" -c MysqlPerms -n -a add --name "$DB1" --user "$U" --perms all

echo "
User added!

Database: "$R"_"$DB1"
Username: "$R"_"$U"
password: "$PW""

}

_adduserall(){

D="$(siteworx -u --login_domain="$DOM" \
-c MysqlDb -a list | awk '{print $1}')"
echo "adding user..."
sudo siteworx -u --login_domain="$DOM" \
-c MysqlUser -n -a add --name "$U" \
--password "$PW" --confirm_password "$PW"

for x in $D; do siteworx -u --login_domain="$DOM" \
-c MysqlPerms -n -a add --name $x --user "$U" --perms all; done

echo "
User added!

Username: "$R"_"$U"
password: "$PW"
"

}

_adduser(){

sudo siteworx -u --login_domain="$DOM" \
-c MysqlUser -n -a add --name "$U" \
--password "$PW" --confirm_password "$PW"
echo "
User added

Username: "$R"_"$U"
password: "$PW""

}

_userinfo1(){
R="$(siteworx -u --login_domain="$DOM" -n \
-c overview -a listAccountDetails \
| head -n1 | awk '{print $2}')"
   echo -n "User: "
   read U
J="$(echo "$U" | grep "$R")"
if [[ -n "$U" ]]; then
U="$(echo "$U" | cut -d_ -f2)"
_addusere
else
U="$(echo "$U")"
_addusere
fi
}

_addusere(){
K="$(sudo siteworx -u --login_domain="$DOM" \
-c MysqlUser -n -a listMysqlUsers | awk '{print $2}' | grep "$U")"

if [[ -z "$K" ]]; then
    echo "No user found by that name"
    _userinfo1
else
    _adduseree
fi
}
_adduseree(){
    echo -n "DB: "
      read B
J="$(echo "$B" | grep "$R")"
    if [[ -n "$J" ]]; then
B="$(echo "$B" | cut -d_ -f2)"
_adduseren
   else
B="$(echo "$B")"
_adduseren
fi
}
_adduseren(){
M="$(sudo siteworx -u --login_domain="$DOM" -n \
-c MysqlDb -a listMysqlDatabases | awk '{print $2}' | grep "$B")"

if [[ -z "$M" ]]; then
    echo "No DB found by that name"
    _adduseree
else
    _adduserex
fi
}
_adduserex(){

sudo siteworx -u --login_domain="$DOM" \
-c MysqlPerms -n -a add --name "$B" --user "$U" --perms all

echo "Permissions added!"
}

_listusers(){
sudo siteworx -u --login_domain="$DOM" \
-c MysqlUser -n -a listMysqlUsers | awk '{print $2}'
}

_helpsec(){

   cat <<- EOF

Usage: uadd argument ex. uadd -a

         supported aruguments

         -a|--add     add new user to all db's
         -e|--exist   add an existing user to an existing db
         -h|--help    display this message
         -l|--list    list all users
         -n|--none    add a new user
         -o|--one     add new user to existing db

EOF
}
if [[ "$1" == "-o" || "$1" == "--one" ]]; then
 _domchk
 _userinfo
_userchk
_adduser1
else
if [[ "$1" == "-e" || "$1" == "--exist" ]]; then
 _domchk
 _userinfo1
else
if [[ "$1" == "-a" || "$1" == "--all" ]]; then
_domchk
_userinfo
_userchk
_adduserall
else
if [[ "$1" == "-n" || "$1" == "--none" ]]; then
_domchk
_userinfo
_userchk
_adduser
else
if [[ "$1" == "-l"  || "$1" == "--list" ]]; then
_domchk
_listusers
else
if [[ "$1" == "-h"  || "$1" == "--help" ]]; then
_helpsec
else
_helpsec
     fi
    fi
   fi
  fi
 fi
fi
