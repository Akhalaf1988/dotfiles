#! /usr/bin/env bash

_domchk(){
D="$(pwd | cut -d/ -f4)"
V="$(ls /etc/httpd/conf.d/ \
| grep "vhost_"$D".conf")"
  if [[ -n "$V" ]]; then
    DOM="$D"
else
    echo -n "Master Domain: "
    read DOM
    _vhostchk
  fi
}

_vhostchk(){
V="$(ls /etc/httpd/conf.d/ \
| grep "vhost_"$DOM".conf")"
  if [[ -z "$V" ]]; then
     echo "No Domain Found"
     _domchk
  fi
}

_dbinfo(){
R="$(siteworx -u --login_domain="$DOM" -n \
-c overview -a listAccountDetails \
| head -n1 | awk '{print $2}')"

   echo -n "DB: "
   read DB
J="$(echo "$DB" | grep "$R")"
if [[ -n "$J" ]]; then
DB="$(echo "$DB" | cut -d_ -f2)"
else
DB="$(echo "$DB")"
fi
}
_dbuinfo(){
   echo -n "User: "
   read U
Y="$(echo "$U" | grep "$R")"
if [[ -n "$Y" ]]; then
U="$(echo "$U" | cut -d_ -f2)"
else
U="$(echo "$U")"
fi
}
_pwg(){
if [[ -e /usr/local/interworx/lib/dict/words ]]; then

    D='/usr/local/interworx/lib/dict/words';
    _getpass
else
   D='/usr/share/dict/words'
   _getpass
fi
}
_getpass(){
W1="$(shuf -n1000 "$D" | head -n1 | sed -e 's|["'\'']||g')"
W2="$(shuf -n1000 "$D" | tail -n1 | sed -e 's|["'\'']||g')"
W3="$(shuf -n1000 "$D" | head -n1 | sed -e 's|["'\'']||g')"
W4="$(shuf -n1000 "$D" | tail -n1 | sed -e 's|["'\'']||g')"
W5="$(shuf -n1000 "$D" | tail -n1 | sed -e 's|["'\'']||g')"
N="$(seq 99 | sort -R | tail -n1)"
 echo ""$W1""$W2""$W3""$W""$W5""$N""
}
_passinfo(){
echo -n "New password (default: random): "
   read PW
 if [ -z "$PW" ]; then
  PW="$(_pwg)"
else
   PW="$PW"
 fi
}
_adddbpu(){

sudo siteworx -u --login_domain="$DOM" -n \
-c MysqlDb -a add --name "$DB" --create_user 1 \
--user "$U" --password "$PW" \
--confirm_password "$PW"

echo "
New DB credentials

DB:   "$R"_"$DB""
echo "User: "$R"_"$U""
echo "Pass: "$PW"

"
}
_dbuinfoe(){

sudo siteworx -u --login_domain="$DOM" -n -c MysqlDb -a add --name "$DB"

sudo siteworx -u --login_domain="$DOM" -c MysqlPerms -n -a add --name "$DB" --user "$U" --perms all
echo "
New DB created

Database: "$R"_"$DB""
echo "DBUser:   "$R"_"$U"
"
}
_adddb(){
sudo siteworx -u --login_domain="$DOM" -n -c MysqlDb -a add --name "$DB"
echo "
DB: "$R"_"$DB"
"
}
_dblist(){
DASH="$(for i in {1..12}; do echo -n "-"; done)"
echo "Db List"
echo "$DASH"
sudo siteworx -u --login_domain="$DOM" -n \
-c MysqlDb -a listMysqlDatabases | awk '{print $2}'
}

_helpsec(){

cat <<- EOF

Usage: dbadd argument ex dbadd -a

   Supposted Aruguments

       -a|--add        Adds a new db
       -e|--existing   Creates new db & adds existing user to it
       -h|--help       Displays this message
       -l|--list       lists all db's
       -n|--new        Creates a new db & new user

EOF
}
if [[ "$1" == "-l" || "$1" == "--list" ]]; then
_domchk
_dblist
else
if [[ "$1" == "-a" || "$1" == "--add" ]]; then
_domchk
_dbinfo
_adddb
else
if [[ "$1" == "-n" || "$1" == "--new" ]]; then
_domchk
_dbinfo
_dbuinfo
_passinfo
_adddbpu
else
if [[ "$1" == "-e" || "$1" == "--existing" ]]; then
_domchk
_dbinfo
_dbuinfo
_dbuinfoe
else
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
_helpsec
else
_helpsec
    fi
   fi
  fi
 fi
fi
